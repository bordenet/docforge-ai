#!/bin/bash
# Pre-commit hook: Update version timestamps in HTML files
# Install with: ./scripts/setup-hooks.sh

set -euo pipefail

# Get current timestamp in ISO 8601 format with timezone (America/Los_Angeles)
if command -v gdate &> /dev/null; then
    # macOS with GNU coreutils
    TIMESTAMP=$(TZ='America/Los_Angeles' gdate '+%Y-%m-%dT%H:%M:%S%:z')
elif [[ "$(uname)" == "Darwin" ]]; then
    # macOS native date (doesn't support %:z, need to format manually)
    TIMESTAMP=$(TZ='America/Los_Angeles' date '+%Y-%m-%dT%H:%M:%S%z' | sed 's/\([+-][0-9][0-9]\)\([0-9][0-9]\)$/\1:\2/')
else
    # Linux
    TIMESTAMP=$(TZ='America/Los_Angeles' date '+%Y-%m-%dT%H:%M:%S%:z')
fi

# Pattern to match existing version timestamps
PATTERN='v:20[0-9][0-9]-[0-9][0-9]-[0-9][0-9]T[0-9][0-9]:[0-9][0-9]:[0-9][0-9][+-][0-9][0-9]:[0-9][0-9]'

UPDATED=0

# Update assistant/index.html
if [[ -f "assistant/index.html" ]]; then
    if grep -qE "$PATTERN" "assistant/index.html"; then
        if [[ "$(uname)" == "Darwin" ]]; then
            sed -i '' "s|$PATTERN|v:${TIMESTAMP}|g" "assistant/index.html"
        else
            sed -i "s|$PATTERN|v:${TIMESTAMP}|g" "assistant/index.html"
        fi
        git add "assistant/index.html"
        UPDATED=1
    fi
fi

# Update validator/index.html
if [[ -f "validator/index.html" ]]; then
    if grep -qE "$PATTERN" "validator/index.html"; then
        if [[ "$(uname)" == "Darwin" ]]; then
            sed -i '' "s|$PATTERN|v:${TIMESTAMP}|g" "validator/index.html"
        else
            sed -i "s|$PATTERN|v:${TIMESTAMP}|g" "validator/index.html"
        fi
        git add "validator/index.html"
        UPDATED=1
    fi
fi

if [[ $UPDATED -eq 1 ]]; then
    echo "üìù Updated version timestamps to v:${TIMESTAMP}"
fi

exit 0

